#!/bin/bash
# Copyright 2015 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

set -e

function follow_links() {
  cd -P "${1%/*}"
  file="$PWD/${1##*/}"
  while [ -h "$file" ]; do
    # On Mac OS, readlink -f doesn't work.
    cd -P "${file%/*}"
    file="$(readlink "$file")"
    cd -P "${file%/*}"
    file="$PWD/${file##*/}"
  done
  echo "$PWD/${file##*/}"
}

PROG_NAME="$(follow_links "$BASH_SOURCE")"
BIN_DIR="$(cd "${PROG_NAME%/*}" ; pwd -P)"
export MULTI_DRIVE_TOOL="$(cd "${BIN_DIR}/.." ; pwd -P)"

SNAPSHOT_PATH="$MULTI_DRIVE_TOOL/bin/cache/multi_drive_tools.snapshot"
SCRIPT_PATH="$MULTI_DRIVE_TOOL/bin/multi_drive.dart"
DART="$(which dart)"
PUB="$(which pub)"

if [ "$DART" = "dart not found" ]; then
  echo "dart is not detected.  Please install dart sdk from www.dartlang.org"
  exit 0
fi

if [ "$PUB" = "pub not found" ]; then
  echo "pub is not detected.  Please install dart sdk from www.dartlang.org"
fi

if [ ! -f "$SNAPSHOT_PATH" ] || [ "$MULTI_DRIVE_TOOL/pubspec.yaml" -nt "$MULTI_DRIVE_TOOL/pubspec.lock" ]; then
  echo Building multi-drive tool...
  (cd "$MULTI_DRIVE_TOOL"; "$PUB" get --verbosity=warning)
  "$DART" --snapshot="$SNAPSHOT_PATH" --packages="$MULTI_DRIVE_TOOL/.packages" "$SCRIPT_PATH"
fi

MULTI_DRIVE_DEV=1

if [ $MULTI_DRIVE_DEV ]; then
  "$DART" --packages="$MULTI_DRIVE_TOOL/.packages" -c "$SCRIPT_PATH" "$@"
else
  set +e
  "$DART" "$SNAPSHOT_PATH" "$@"

  EXIT_CODE=$?
  if [ $EXIT_CODE != 253 ]; then
    exit $EXIT_CODE
  fi
  
  set -e
  "$DART" --snapshot="$SNAPSHOT_PATH" --package="$MULTI_DRIVE_TOOL/.package" "$SCRIPT_PATH"
  "$DART" "$SNAPSHOT_PATH" "$@"
fi
